apiVersion: v1
kind: ConfigMap
metadata:
  name: spire-bootstrap
data:
  bootstrap.sh: |
    #!/usr/bin/env sh

    # create spire agent svid
    /opt/spire/bin/spire-server entry create \
        -spiffeID "spiffe://{{ .Values.partnerTrustDomain }}/ns/{{ .Release.Namespace }}/sa/spire-agent" \
        -selector "k8s_sat:cluster:{{ .Values.clusterName }}" \
        -selector "k8s_sat:agent_ns:{{ .Release.Namespace }}" \
        -selector k8s_sat:agent_sa:spire-agent \
        -node

    # create hos-proxy svid
    ./bin/spire-server entry create \
        -parentID "spiffe://{{ .Values.partnerTrustDomain }}/ns/{{ .Release.Namespace }}/sa/spire-agent" \
        -spiffeID "spiffe://{{ .Values.partnerTrustDomain }}/ns/{{ .Release.Namespace }}/sa/hos-proxy" \
        -selector "k8s:ns:{{ .Release.Namespace }}" \
        -federatesWith "spiffe://{{ .Values.carelon.spire.trustDomain }}"